image: markussh/bsv_riscv-gcc:latest

variables:
  XILINX_VIVADO: "/opt/cad/xilinx/vitis/Vivado/2020.2"
  XILINX_LICENSE_FILE: "/opt/cad/keys/xilinx"

stages:
  - deps
  - build
  - isa
  - embench (gshare)
  - embench (gskewed)
  - embench (smiths)
  - embench (no predictor)

before_script:
  # Vivado
  - export PATH="${XILINX_VIVADO}/bin:${PATH}:/opt/bsc/bin"
  - export LC_ALL=C
  
  # cloning submodules
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.esa.informatik.tu-darmstadt.de/".insteadOf "https://gitlab.esa.informatik.tu-darmstadt.de/"
  - git submodule deinit -f .
  - git submodule sync
  - git submodule update --init --recursive

deps:
  stage: deps
  script:

  # BSV tools
  - pushd core
  - /opt/bsvtools/bsvAdd.py
  - popd
  
  # Build ISA testbench
  - pushd tools/riscv-tests
  - cp -r ../riscv-tests-override/* .
  - ls
  - ./configure
  - make install BUS=128
  - popd

  # Build embench
  - pushd tools/embench
  - pushd embench-iot
  - git reset --hard HEAD
  - popd
  - make patch
  - make
  - make install
  - popd
  
  artifacts:
    paths:
      - core/.bsv_tools
      - testPrograms/*

buildSimple:
  stage: build
  script:
  - |
    cp testConfigs/simple_gshare.bsv core/src/Config.bsv
    cd core
    make SIM_TYPE=VERILOG ip
    
buildMedium:
  stage: build
  script:
  - |
    cp testConfigs/medium_gshare.bsv core/src/Config.bsv
    cd core
    make SIM_TYPE=VERILOG ip
    
buildHigh:
  stage: build
  script:
  - |
    cp testConfigs/high_gshare.bsv core/src/Config.bsv
    cd core
    make SIM_TYPE=VERILOG ip

run_isaTb_simple:
  stage: isa
  script:
    - cp testConfigs/simple_smiths.bsv core/src/Config.bsv
    - pushd core
    - make TB=ISA_TB
    - popd
    
run_isaTb_medium:
  stage: isa
  script:
    - cp testConfigs/medium_gshare.bsv core/src/Config.bsv
    - pushd core
    - make TB=ISA_TB
    - popd
    
run_isaTb_high:
  stage: isa
  script:
    - cp testConfigs/high_nopred.bsv core/src/Config.bsv
    - pushd core
    - make TB=ISA_TB
    - popd

run_embenchTb_smiths_simple:
  stage: embench (smiths)
  timeout: 24h
  script:
    - cp testConfigs/simple_smiths.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_smiths_medium:
  stage: embench (smiths)
  timeout: 24h
  script:
    - cp testConfigs/medium_smiths.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_smiths_high:
  stage: embench (smiths)
  timeout: 24h
  script:
    - cp testConfigs/high_smiths.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd

run_embenchTb_gshare_simple:
  stage: embench (gshare)
  timeout: 24h
  script:
    - cp testConfigs/simple_gshare.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_gshare_medium:
  stage: embench (gshare)
  timeout: 24h
  script:
    - cp testConfigs/medium_gshare.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_gshare_high:
  stage: embench (gshare)
  timeout: 24h
  script:
    - cp testConfigs/high_gshare.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd

run_embenchTb_none_simple:
  stage: embench (no predictor)
  timeout: 24h
  script:
    - cp testConfigs/simple_nopred.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_none_medium:
  stage: embench (no predictor)
  timeout: 24h
  script:
    - cp testConfigs/medium_nopred.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_none_high:
  stage: embench (no predictor)
  timeout: 24h
  script:
    - cp testConfigs/high_nopred.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd

run_embenchTb_gskewed_simple:
  stage: embench (gskewed)
  timeout: 24h
  script:
    - cp testConfigs/simple_gskewed.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_gskewed_medium:
  stage: embench (gskewed)
  timeout: 24h
  script:
    - cp testConfigs/medium_gskewed.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
    
run_embenchTb_gskewed_high:
  stage: embench (gskewed)
  timeout: 24h
  script:
    - cp testConfigs/high_gskewed.bsv core/src/Config.bsv
    - pushd core
    - make TB=EMBENCH_TB BRANCH=1
    - popd
